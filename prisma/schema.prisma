generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model permissions {
  id               String             @id @db.Uuid
  code             String             @unique @db.VarChar(100)
  description      String?
  role_permissions role_permissions[]
}

model refresh_tokens {
  id         String    @id @db.Uuid
  user_id    String    @db.Uuid
  token_hash String
  user_agent String?
  ip_address String?
  expires_at DateTime  @db.Timestamp(6)
  revoked_at DateTime? @db.Timestamp(6)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  users      users     @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model role_permissions {
  role_id       String      @db.Uuid
  permission_id String      @db.Uuid
  permissions   permissions @relation(fields: [permission_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  roles         roles       @relation(fields: [role_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([role_id, permission_id])
}

model roles {
  id                    String                  @id @db.Uuid
  name                  String                  @unique @db.VarChar(50)
  description           String?
  document_access_rules document_access_rules[]
  role_permissions      role_permissions[]
  user_roles            user_roles[]
}

model user_roles {
  user_id String @db.Uuid
  role_id String @db.Uuid
  roles   roles  @relation(fields: [role_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users   users  @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([user_id, role_id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model users {
  id             String           @id @db.Uuid
  email          String           @unique @db.VarChar(255)
  password_hash  String
  full_name      String?          @db.VarChar(255)
  status         String?          @db.VarChar(20)
  created_at     DateTime?        @default(now()) @db.Timestamp(6)
  updated_at     DateTime?        @db.Timestamp(6)
  chats          chats[]
  documents      documents[]
  refresh_tokens refresh_tokens[]
  user_profiles  user_profiles?
  user_roles     user_roles[]
}

model departments {
  id                    String                  @id @db.Uuid
  name                  String                  @db.VarChar(100)
  description           String?
  document_access_rules document_access_rules[]
  user_profiles         user_profiles[]
}

model positions {
  id                    String                  @id @db.Uuid
  name                  String                  @db.VarChar(100)
  level                 Int
  document_access_rules document_access_rules[]
  user_profiles         user_profiles[]
}

model user_profiles {
  user_id       String       @id @db.Uuid
  department_id String?      @db.Uuid
  position_id   String?      @db.Uuid
  joined_at     DateTime?    @db.Date
  departments   departments? @relation(fields: [department_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  positions     positions?   @relation(fields: [position_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users         users        @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model data_sources {
  id         String      @id @db.Uuid
  type       String      @db.VarChar(50)
  name       String?
  config     Json?
  created_at DateTime?   @default(now()) @db.Timestamp(6)
  documents  documents[]
}

model document_access_rules {
  id            String       @id @db.Uuid
  document_id   String       @db.Uuid
  department_id String?      @db.Uuid
  position_id   String?      @db.Uuid
  role_id       String?      @db.Uuid
  access_level  String?      @default("READ") @db.VarChar(20)
  departments   departments? @relation(fields: [department_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  documents     documents    @relation(fields: [document_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  positions     positions?   @relation(fields: [position_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  roles         roles?       @relation(fields: [role_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model documents {
  id                    String                  @id @db.Uuid
  title                 String
  source_type           String?                 @db.VarChar(50)
  file_type             String?                 @db.VarChar(50)
  source_id             String?                 @db.Uuid
  file_path             String?
  uploaded_by           String?                 @db.Uuid
  status                String?                 @db.VarChar(20)
  created_at            DateTime?               @default(now()) @db.Timestamp(6)
  updated_at            DateTime?               @db.Timestamp(6)
  document_access_rules document_access_rules[]
  data_sources          data_sources?           @relation(fields: [source_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users                 users?                  @relation(fields: [uploaded_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model chats {
  id         String     @id @db.Uuid
  user_id    String     @db.Uuid
  title      String?
  created_at DateTime?  @default(now()) @db.Timestamp(6)
  users      users      @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  messages   messages[]
}

model messages {
  id         String    @id @db.Uuid
  chat_id    String    @db.Uuid
  role       String?   @db.VarChar(10)
  content    String?
  created_at DateTime? @default(now()) @db.Timestamp(6)
  chats      chats     @relation(fields: [chat_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}
